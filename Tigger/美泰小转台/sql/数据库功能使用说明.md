# 数据库功能使用说明

## 概述

本系统集成了完整的SQLite数据库功能，用于记录和管理芯片测试过程中的所有数据。数据库功能包括：

- 芯片测试数据的自动记录
- 生产批次管理
- 测试时间记录
- 打标号管理
- 激活过程数据记录
- 小转台标定测试数据记录
- 分选过程数据记录
- 多维度查询功能
- CSV数据导入导出

## 数据库表结构

### chip_test_data 表

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| uid | TEXT | 芯片UID | 复合主键 |
| chip_model | TEXT | 芯片型号 | 如MTI270 |
| lotid | TEXT | 批次ID | 复合主键 |
| activation_time | TEXT | 激活时间 | |
| marking_number | TEXT | 打标号 | |
| working_current_measured | REAL | 工作电流测量值 | |
| working_current_reference | REAL | 工作电流参考值 | |
| pll_dc_voltage_measured | REAL | 锁相环直流电压测量值 | |
| pll_dc_voltage_reference | REAL | 锁相环直流电压参考值 | |
| drive_dc_voltage_measured | REAL | 驱动直流电压测量值 | |
| drive_dc_voltage_reference | REAL | 驱动直流电压参考值 | |
| drive_dc_peak_voltage_measured | REAL | 驱动直流电压峰值测量值 | |
| drive_dc_peak_voltage_reference | REAL | 驱动直流电压峰值参考值 | |
| square_wave_freq_measured | REAL | 方波频率测量值 | |
| square_wave_freq_reference | REAL | 方波频率参考值 | |
| sine_wave_voltage_avg_measured | REAL | 正弦波电压均值测量值 | |
| sine_wave_voltage_avg_reference | REAL | 正弦波电压均值参考值 | |
| sine_wave_peak_voltage_measured | REAL | 正弦波电压峰值测量值 | |
| sine_wave_peak_voltage_reference | REAL | 正弦波电压峰值参考值 | |
| sine_wave_freq_measured | REAL | 正弦波频率测量值 | |
| sine_wave_freq_reference | REAL | 正弦波频率参考值 | |
| activation_ok_ng | INTEGER | 激活测试结果 | 0=失败, 1=通过 |
| turntable_calibration_ok_ng | INTEGER | 小转台标定结果 | 0=失败, 1=通过 |
| machine_number | TEXT | 机器号 | |
| workflow_file | TEXT | 工作流文件 | |
| automation_task_file | TEXT | 自动化任务文件 | |
| burn_task_file | TEXT | 烧录任务文件 | |
| os_test_result | INTEGER | OS测试结果 | 0=失败, 1=通过 |
| os_test_details | TEXT | OS测试详细信息 | |
| calibration_params | TEXT | 标定参数 | JSON格式 |
| param1-param10 | TEXT | 预留参数1-10 | 扩展用 |
| created_at | DATETIME | 创建时间 | 自动生成 |
| updated_at | DATETIME | 更新时间 | 自动更新 |

## 功能模块

### 1. DatabaseService (数据库服务)

**位置**: `include/services/DatabaseService.h`, `src/services/DatabaseService.cpp`

**功能**: 提供数据库操作的统一接口，采用单例模式。

**主要接口**:

```cpp
// 初始化数据库
bool initializeDatabase(const QString &databasePath = "data/chip_test.db");

// 插入数据
bool insertChipTestData(const ChipTestData &data);
bool insertChipTestDataFromJson(const QJsonObject &jsonData);
bool insertChipTestDataFromCsv(const QString &csvFilePath);

// 查询数据
QList<ChipTestData> getAllChipData();
QList<ChipTestData> getChipDataByModel(const QString &chipModel);
QList<ChipTestData> getChipDataByLot(const QString &lotid);
ChipTestData getChipData(const QString &uid, const QString &lotid);

// 统计信息
int getTotalChipCount();
QStringList getAllChipModels();
QStringList getAllLotIds();
```

### 2. DatabaseWidget (数据库界面)

**位置**: `include/ui/DatabaseWidget.h`, `src/ui/DatabaseWidget.cpp`

**功能**: 提供用户友好的数据库管理界面。

**主要功能**:
- 多条件查询（日期、批次、UID、打标号）
- 数据表格显示
- CSV导入导出
- 统计信息显示
- 实时搜索

### 3. ChipTestDatabase (数据库底层)

**位置**: `sql/ChipTestDatabase.h`, `sql/ChipTestDatabase.cpp`

**功能**: SQLite数据库的底层操作封装。

## 使用方法

### 1. 界面操作

1. **启动程序**: 数据库会自动初始化
2. **切换到数据库Tab**: 在主界面点击"数据库"标签页
3. **查询数据**: 
   - 使用快速搜索框进行实时搜索
   - 设置日期范围进行时间段查询
   - 输入批次号进行批次查询
   - 输入UID或打标号进行精确查询
4. **导出数据**: 点击"导出数据"按钮，选择保存位置
5. **导入CSV**: 点击"导入CSV"按钮，选择CSV文件

### 2. 编程接口

#### 获取数据库服务实例

```cpp
#include "services/DatabaseService.h"

Services::DatabaseService& dbService = Services::DatabaseService::getInstance();
```

#### 插入测试数据

```cpp
// 方式1: 直接插入结构体
ChipTestData data;
data.uid = "CHIP_001";
data.chipModel = "MTI270";
data.lotid = "BATCH_001";
data.activationTime = QDateTime::currentDateTime().toString("yyyy-MM-dd hh:mm:ss");
data.markingNumber = "MRK_001";
data.workingCurrentMeasured = 3.2;
data.activationOkNg = true;

dbService.insertChipTestData(data);

// 方式2: 从JSON插入
QJsonObject jsonData;
jsonData["uid"] = "CHIP_002";
jsonData["chip_model"] = "MTI270";
jsonData["lotid"] = "BATCH_001";
jsonData["working_current_measured"] = 3.5;
jsonData["activation_ok_ng"] = true;

dbService.insertChipTestDataFromJson(jsonData);
```

#### 查询数据

```cpp
// 查询所有数据
QList<ChipTestData> allData = dbService.getAllChipData();

// 按型号查询
QList<ChipTestData> modelData = dbService.getChipDataByModel("MTI270");

// 按批次查询
QList<ChipTestData> lotData = dbService.getChipDataByLot("BATCH_001");

// 查询单条记录
ChipTestData singleData = dbService.getChipData("CHIP_001", "BATCH_001");
```

#### 统计信息

```cpp
// 获取总记录数
int totalCount = dbService.getTotalChipCount();

// 获取所有芯片型号
QStringList models = dbService.getAllChipModels();

// 获取所有批次
QStringList lots = dbService.getAllLotIds();
```

### 3. 自动数据记录

系统会自动监听测试结果信号，并将数据记录到数据库中：

```cpp
// 在MainWindow中已经连接了信号
connect(m_coreEngine.get(), &Core::CoreEngine::testResultAvailable,
        &Services::DatabaseService::getInstance(), &Services::DatabaseService::onTestDataAvailable);
```

### 4. CSV数据格式

导入的CSV文件应包含以下列（按顺序）：

```
uid,chip_model,lotid,activation_time,marking_number,working_current_measured,working_current_reference,...
CHIP_001,MTI270,BATCH_001,2024-10-22 10:30:00,MRK_001,3.2,3.0,...
```

## 数据库文件位置

- 默认路径: `data/chip_test.db`
- 可通过配置修改路径
- 支持相对路径和绝对路径

## 性能优化

1. **索引**: 已为常用查询字段创建索引
   - chip_model
   - lotid  
   - activation_time
   - created_at

2. **批量操作**: 支持批量插入以提高性能

3. **连接池**: 使用单例模式管理数据库连接

## 错误处理

所有数据库操作都包含错误处理：

```cpp
if (!dbService.insertChipTestData(data)) {
    QString error = dbService.getLastError();
    qDebug() << "插入失败:" << error;
}
```

## 扩展接口

系统预留了10个参数字段（param1-param10）用于未来扩展，可以存储额外的测试数据或配置信息。

## 注意事项

1. **数据完整性**: UID和批次ID组成复合主键，确保数据唯一性
2. **时间格式**: 建议使用 "yyyy-MM-dd hh:mm:ss" 格式
3. **数据验证**: 插入前会进行基本数据验证
4. **备份**: 建议定期备份数据库文件
5. **权限**: 确保程序对数据库目录有读写权限

## 故障排除

1. **数据库初始化失败**: 检查目录权限和磁盘空间
2. **查询慢**: 检查是否有大量数据，考虑添加索引
3. **CSV导入失败**: 检查CSV格式和编码（建议UTF-8）
4. **界面无响应**: 大量数据操作时会显示进度条，请耐心等待
