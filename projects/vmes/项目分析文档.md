# VMES 项目分析文档

## 项目概述

**VMES** 是一个基于 Go 语言开发的简单 MES（制造执行系统）模拟器，实现了基本的 MES 接口 POST 操作。该项目主要用于测试和模拟 MES 系统的各种接口功能，支持 REST API 和 SOAP Web Service 两种通信方式。

### 版本信息
- **当前版本**: V1.0.8_230915
- **Go 版本**: 1.18
- **开发语言**: Go
- **主要框架**: Gin (Web 框架), SOAP (Web Service)

## 项目架构

### 核心组件

1. **主服务器** (`main.go`)
   - 基于 Gin 框架的 HTTP 服务器
   - 提供 REST API 接口
   - 支持 GET 和 POST 请求

2. **SOAP 服务器** (`soapserver/` 包)
   - 独立的 SOAP Web Service 实现
   - 支持 SOAP 1.1 和 SOAP 1.2 协议
   - 提供 XML 格式的数据交换

3. **配置管理** (`config.yaml`)
   - YAML 格式的配置文件
   - 支持端口和 URL 自定义
   - 集中管理所有接口端点

## 技术栈

### 依赖包
```go
require (
    github.com/foomo/soap v0.1.0      // SOAP 协议支持
    github.com/gin-gonic/gin v1.8.1  // Web 框架
    gopkg.in/yaml.v2 v2.4.0          // YAML 配置解析
)
```

### 核心特性
- ✅ REST API 接口支持
- ✅ SOAP Web Service 支持
- ✅ 配置文件驱动
- ✅ 多端口服务
- ✅ 文件下载功能
- ✅ JSON/XML 数据格式支持

## 项目结构

```
vmes/
├── main.go                 # 主程序入口
├── config.yaml            # 配置文件
├── go.mod                  # Go 模块定义
├── go.sum                  # 依赖版本锁定
├── README.md               # 项目说明
├── soapserver/            # SOAP 服务器包
│   ├── client.go          # SOAP 客户端实现
│   ├── server.go          # SOAP 服务器实现
│   └── soap.go            # SOAP 协议定义
├── *.json                 # 响应数据模板
│   ├── login.json         # 登录响应
│   ├── token.json         # Token 响应
│   ├── location.json      # 位置信息响应
│   ├── order.json         # 工单信息响应
│   ├── success.json       # 成功响应
│   └── getsninfo.json     # SN 信息响应
├── *.xml                  # SOAP 请求/响应模板
├── *.tar.gz               # 测试文件
└── setting.png            # 配置文件图标
```

## 功能模块

### 1. REST API 接口

#### 认证相关
- **登录接口**: `POST/GET /mes/login`
  - 返回操作员等级信息
  - 响应格式: `login.json`

- **获取 Token**: `POST/GET /mes/gettoken`
  - 返回认证令牌
  - 响应格式: `token.json`

#### 数据获取
- **获取位置信息**: `POST/GET /mes/getlocation`
  - 返回服务器位置和状态信息
  - 响应格式: `location.json`

- **获取工单信息**: `POST/GET /mes/getworkorder`
  - 返回项目、芯片列表、数量等详细信息
  - 响应格式: `order.json`

- **获取 SN 信息**: `POST/GET /mes/getsninfo`
  - 根据机架号、工厂ID和芯片名称获取序列号烧录信息
  - 请求参数: `rack_number`, `factory_id`, `chip_name`
  - 响应格式: `getsninfo.json`

#### 数据发送
- **发送任务信息**: `POST/GET /mes/sendtaskinfo`
- **发送报警信息**: `POST/GET /mes/sendalarminfo`
- **发送操作呼叫**: `POST/GET /mes/sendopecall`
- **发送程序信息**: `POST/GET /mes/sendproginfo`
- **发送程序结果**: `POST/GET /mes/sendprogresult`
- **发送报告**: `POST/GET /mes/sendreort`

所有发送接口均返回成功响应，格式: `success.json`

#### 文件下载
- **测试文件下载**: `GET /download/Test.tar.gz`
- **EMMC 测试文件**: `GET /download/TestEMMC.tar.gz`

### 2. SOAP Web Service

#### SOAP 服务器
- **监听端口**: 8088 (可配置)
- **服务路径**: `/mes/soap.asmx`
- **SOAP Action**: `SendResult`
- **消息类型**: `ProgramResult`

#### SOAP 请求/响应结构
```xml
<!-- 请求 -->
<Envelope xmlns="http://schemas.xmlsoap.org/soap/envelope/">
    <Body>
        <ProgramResult>
            <PassCnt>5</PassCnt>
            <FailCnt>2</FailCnt>
            <TotalCnt>3</TotalCnt>
        </ProgramResult>
    </Body>
</Envelope>

<!-- 响应 -->
<Envelope xmlns="http://schemas.xmlsoap.org/soap/envelope/">
    <Body>
        <ProgramResult>
            <PassCnt>Hello 5</PassCnt>
            <FailCnt>Hello 2</FailCnt>
            <TotalCnt>Hello 3</TotalCnt>
        </ProgramResult>
    </Body>
</Envelope>
```

## 配置说明

### config.yaml 配置项

```yaml
ListenPort: 8080                    # REST API 监听端口
LoginUrl: /mes/login                # 登录接口路径
GetTokenUrl: /mes/gettoken          # 获取 Token 接口路径
GetLocationUrl: /mes/getlocation    # 获取位置信息接口路径
GetWorkOrderUrl: /mes/getworkorder  # 获取工单信息接口路径
SendTaskInfoUrl: /mes/sendtaskinfo  # 发送任务信息接口路径
SendAlarmInfoUrl: /mes/sendalarminfo # 发送报警信息接口路径
SendOpeCallUrl: /mes/sendopecall     # 发送操作呼叫接口路径
SendProgInfoUrl: /mes/sendproginfo   # 发送程序信息接口路径
SendProgResultUrl: /mes/sendprogresult # 发送程序结果接口路径
SendReortUrl: /mes/sendreort        # 发送报告接口路径
GetSnInfoUrl: /mes/getsninfo        # 获取 SN 信息接口路径
SOAPListenPort: 8088                # SOAP 服务监听端口
SOAPUrl: /mes/soap.asmx             # SOAP 服务路径
SOAPAction: SendResult              # SOAP Action
SOAPBodyContentType: ProgramResult  # SOAP 消息体内容类型
```

## 数据格式

### JSON 响应格式

#### 登录响应 (login.json)
```json
{
    "ErrMsg": "",
    "Result": 1,
    "OperatorLevel": 1
}
```

#### Token 响应 (token.json)
```json
{
    "ErrMsg": "",
    "Result": 1,
    "data": "AG32312B"
}
```

#### 工单信息响应 (order.json)
```json
{
    "success": true,
    "message": "",
    "code": 200,
    "result": {
        "Project": [
            {
                "SOFTWAREID": "RJ-0022111",
                "SOFTWARENAME": "AMBER-S-2022.1.11.rar"
            }
        ],
        "Quantity": 1000,
        "Remark": "001030012634",
        "Model": "AP800",
        "OrderName": "001030012634",
        "ComponentName": "7459S26I436H0016",
        "ChipList": [
            {
                "CHIP_NUMBER": "NA00121",
                "CHIP_NAME": "08QA"
            }
        ],
        "ErrMsg": "",
        "Result": "true"
    },
    "timestamp": 1662369763368
}
```

#### 成功响应 (success.json)
```json
{
    "success": true,
    "message": "",
    "code": 200,
    "result": {
        "ErrMsg": "",
        "Result": "true"
    },
    "timestamp": 1662369763368
}
```

#### SN 信息响应 (getsninfo.json)
```json
{
    "burn_sn": 1,
    "write_address": "0x402C0868",
    "data_length": 7,
    "serial_number": "0e250912010101"
}
```

**字段说明:**
- `burn_sn`: 是否烧录 SN（1=烧录，0=不烧录）
- `write_address`: 写入起始地址（十六进制字符串）
- `data_length`: 写入长度（字节）
- `serial_number`: SN 内容（字符串，十六进制）

## 部署和运行

### 环境要求
- Go 1.18 或更高版本
- 网络端口 8080 和 8088 可用

### 运行步骤

1. **安装依赖**
   ```bash
   go mod tidy
   ```

2. **配置服务**
   - 编辑 `config.yaml` 文件
   - 设置合适的端口和 URL 路径

3. **启动服务**
   ```bash
   go run main.go
   ```

4. **验证服务**
   - REST API: `http://localhost:8080/mes/login`
   - SOAP Service: `http://localhost:8088/mes/soap.asmx`

## 版本历史

### V1.0.8_230915
- 增加 GET 方法的支持

### V1.0.7_230721
- 增加支持简单 SOAP 操作

### V1.0.6_230712
- 增加支持 MES 接口，支持 V1.3 MES 接口文档
- 支持端口自定义
- 支持下载两个文件 `/download/TestEMMC.tar.gz`，`/download/Test.tar.gz`

### V1.0.3_221026
- 增加打印功能

### V1.0.1
- 使用 YAML 配置文件

### V1.0
- 初始版本

## 使用场景

### 1. MES 系统测试
- 模拟 MES 系统的各种接口
- 测试客户端与 MES 系统的集成
- 验证数据传输格式和协议

### 2. 开发调试
- 为 MES 客户端开发提供测试环境
- 模拟各种响应场景
- 调试网络通信问题

### 3. 接口验证
- 验证 REST API 和 SOAP Web Service 的兼容性
- 测试不同数据格式的处理
- 验证错误处理机制

## 技术特点

### 优点
- ✅ **轻量级**: 无数据库依赖，使用文件存储响应模板
- ✅ **灵活配置**: YAML 配置文件，易于修改和部署
- ✅ **双协议支持**: 同时支持 REST 和 SOAP 协议
- ✅ **易于扩展**: 模块化设计，便于添加新接口
- ✅ **跨平台**: Go 语言实现，支持多平台部署

### 限制
- ❌ **无数据持久化**: 所有响应都是静态文件
- ❌ **无业务逻辑**: 仅返回预定义的响应数据
- ❌ **无认证机制**: 缺少真实的安全验证
- ❌ **无数据验证**: 不验证请求数据的有效性

## 扩展建议

### 1. 功能增强
- 添加数据库支持，实现动态数据管理
- 实现真实的业务逻辑处理
- 添加用户认证和权限管理
- 支持数据验证和错误处理

### 2. 性能优化
- 添加缓存机制
- 实现连接池管理
- 添加日志记录和监控
- 支持负载均衡

### 3. 部署改进
- 添加 Docker 支持
- 实现配置热更新
- 添加健康检查接口
- 支持集群部署

## 总结

VMES 是一个功能完整的 MES 系统模拟器，为 MES 客户端开发和测试提供了良好的基础环境。项目结构清晰，代码简洁，易于理解和维护。虽然功能相对简单，但已经覆盖了 MES 系统的主要接口需求，是一个优秀的测试和开发工具。

通过持续的版本迭代，项目已经具备了基本的 MES 接口功能，支持多种通信协议和数据格式，为后续的功能扩展和性能优化奠定了坚实的基础。
